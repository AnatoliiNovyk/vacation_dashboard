---
id: ARCH-APP-core-routing-auth
title: "Логіка: Ядро, Маршрутизація та Автентифікація"
type: component
layer: application
owner: "@unassigned"
version: v1
status: current
created: 2025-06-02
updated: 2025-06-02
tags: [app, core, routing, authentication, session, dash, flask]
depends_on:
  - ARCH-DATA-storage
  - ARCH-AUTH-middleware
  - ARCH-UI-employee-dashboard
  - ARCH-UI-manager-dashboard
  - ARCH-UI-hr-dashboard
referenced_by: []
---
## Контекст
Цей архітектурний компонент описує основну логіку додатку, включаючи ініціалізацію, маршрутизацію, автентифікацію користувачів та управління сесіями. Він реалізований переважно у файлі `app.py`.

## Структура
*   **Розташування:** `app.py`
*   **Ініціалізація:**
    *   Створення екземпляру Flask сервера (`server = Flask(__name__)`).
    *   Генерація та встановлення секретного ключа для сесій (`server.secret_key`).
    *   Створення екземпляру Dash додатку (`app = Dash(...)`).
    *   Застосування проміжного ПЗ для перевірки ролей (`role_check_middleware`), хоча його реалізація в `ARCH-AUTH-middleware` є базовою.
*   **Сторінка Входу:**
    *   Функція `login_page_layout()`: генерує UI для сторінки входу, що вимагає ІПН.
*   **Конфігурація Ролей та Шляхів:**
    *   Словники `ROLE_DASHBOARDS` та `ROLE_PATHS`: маплять ролі користувачів на відповідні макети панелей інструментів та URL-шляхи.
*   **Основний Макет Додатку:**
    *   Визначає загальну структуру сторінки з `dcc.Location` для відстеження URL, `user-status-header` для інформації про користувача та посилання для виходу, і `page-content` для динамічного відображення вмісту.
*   **Ключові Callback-функції:**
    *   `update_user_header`: оновлює заголовок сторінки з інформацією про поточного користувача та посиланням "Вийти".
    *   `process_login`: обробляє спробу входу користувача. Перевіряє ІПН через `ARCH-DATA-storage`, встановлює дані сесії (`user_ipn`, `user_role`, `user_fio`) та перенаправляє на відповідну панель.
    *   `display_page_content`: основний callback для маршрутизації. Залежно від стану автентифікації та URL-шляху, відображає або сторінку входу, або відповідну панель інструментів для ролі користувача, або перенаправляє на сторінку входу.

## Поведінка
### Автентифікація
1.  Користувач потрапляє на сторінку входу (якщо не автентифікований).
2.  Вводить свій ІПН та натискає "Увійти".
3.  `process_login` викликає `db_operations.get_employee_by_ipn()` для перевірки ІПН.
4.  У разі успіху, роль та ПІБ користувача зберігаються в сесії Flask. Користувач перенаправляється на свою панель.
5.  У разі невдачі, відображається повідомлення про помилку.

### Маршрутизація
*   `display_page_content` контролює, який вміст відображається.
*   Якщо користувач автентифікований, він перенаправляється на панель, що відповідає його ролі. Спроби доступу до інших панелей або сторінки входу перенаправляють на його "домашню" панель.
*   Якщо користувач не автентифікований, будь-яка спроба доступу до захищених сторінок перенаправляє на `/login`.
*   Шлях `/logout` очищує сесію та перенаправляє на сторінку входу.

### Управління Сесіями
*   Використовуються сесії Flask (`session`) для зберігання інформації про автентифікованого користувача (`user_ipn`, `user_role`, `user_fio`).
*   Секретний ключ (`server.secret_key`) використовується для підпису куків сесії.

## Еволюція
### Заплановано
— Можливе розширення механізму автентифікації (наприклад, паролі, двофакторна автентифікація).
— Більш детальна реалізація `role_check_middleware` для гранулярного контролю доступу.
### Історичне
— v1: Початкова реалізація ядра додатку з IPN-автентифікацією, базовою маршрутизацією на основі ролей та управлінням сесіями. 